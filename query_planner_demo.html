<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Query Planner Demo - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "planner-blue": "#1E40AF",
              "stage-parse": "#34D399",
              "stage-logical": "#FBBF24",
              "stage-optimize": "#F87171",
              "stage-physical": "#60A5FA",
              "stage-execute": "#8B5CF6",
            },
          },
        },
      };
    </script>
    <style>
      .flow-step {
        transition: all 0.3s ease-in-out;
        border: 2px solid transparent;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        padding: 0.75rem;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .active-step {
        transform: scale(1.05);
        box-shadow: 0 10px 15px rgba(30, 64, 175, 0.4);
        border-color: rgba(30, 64, 175, 1);
      }
      .terminal {
        background-color: #1f2937;
        color: #34d399;
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: monospace;
        font-size: 0.875rem;
        min-height: 150px;
        max-height: 50vh;
        overflow-y: auto;
        white-space: pre-wrap;
        line-height: 1.5;
      }
      .result-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.9rem;
      }
      .result-table th,
      .result-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }
      .result-table th {
        background-color: #f3f4f6;
        font-weight: 600;
        color: #1f2937;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
      }
      .result-table tr:hover {
        background-color: #f9fafb;
      }
      .query-preset {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid #e5e7eb;
      }
      .query-preset:hover {
        border-color: #1e40af;
        background-color: #eff6ff;
        transform: translateY(-2px);
      }
      .query-preset.selected {
        border-color: #1e40af;
        background-color: #dbeafe;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">
          DB Query Planning Pipeline Demo
        </h1>
        <p class="text-gray-600">
          Educational Query Planner - Visualizing SQL Optimization
        </p>
        <div
          class="mt-4 inline-flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-lg text-sm"
        >
          <span id="statusIndicator">‚óè</span>
          <span id="statusText">Checking server...</span>
        </div>
      </div>

      <!-- Sample Queries -->
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">
          üìö Sample Queries (Click to Load)
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          <div class="query-preset p-3 rounded-lg" onclick="loadQuery(1)">
            <div class="font-bold text-sm text-blue-700">
              Q1: Basic Selection
            </div>
            <div class="text-xs text-gray-600 mt-1">
              Simple filter without optimization
            </div>
          </div>
          <div class="query-preset p-3 rounded-lg" onclick="loadQuery(2)">
            <div class="font-bold text-sm text-blue-700">
              Q2: LIMIT Pushdown
            </div>
            <div class="text-xs text-gray-600 mt-1">
              See optimization in action
            </div>
          </div>
          <div class="query-preset p-3 rounded-lg" onclick="loadQuery(3)">
            <div class="font-bold text-sm text-blue-700">
              Q3: Expensive Arithmetic
            </div>
            <div class="text-xs text-gray-600 mt-1">
              80% computation savings
            </div>
          </div>
          <div class="query-preset p-3 rounded-lg" onclick="loadQuery(4)">
            <div class="font-bold text-sm text-blue-700">
              Q4: String Filtering
            </div>
            <div class="text-xs text-gray-600 mt-1">
              Case-insensitive comparison
            </div>
          </div>
          <div class="query-preset p-3 rounded-lg" onclick="loadQuery(5)">
            <div class="font-bold text-sm text-blue-700">Q5: All Columns</div>
            <div class="text-xs text-gray-600 mt-1">
              Full projection example
            </div>
          </div>
          <div class="query-preset p-3 rounded-lg" onclick="loadQuery(6)">
            <div class="font-bold text-sm text-blue-700">
              Q6: Multiple Operations
            </div>
            <div class="text-xs text-gray-600 mt-1">Arithmetic + filtering</div>
          </div>
        </div>
      </div>

      <!-- Input Section -->
      <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              SQL Query
            </label>
            <input
              type="text"
              id="sqlInput"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-planner-blue focus:border-planner-blue text-sm font-mono"
              placeholder="SELECT col1, col2 FROM table WHERE condition LIMIT N"
            />
          </div>
          <div class="md:col-span-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Table Name
            </label>
            <input
              type="text"
              id="tableName"
              value="nl_weather"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-planner-blue focus:border-planner-blue text-sm font-mono"
            />
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Mock Data (CSV Format)
          </label>
          <textarea
            id="dataInput"
            rows="8"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-planner-blue focus:border-planner-blue text-xs font-mono"
            placeholder="header1,header2,header3..."
          ></textarea>
        </div>

        <button
          onclick="runQuery()"
          id="runButton"
          class="w-full bg-planner-blue hover:bg-blue-800 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          ‚ñ∂ EXECUTE QUERY PIPELINE
        </button>
      </div>

      <!-- Pipeline Visualization -->
      <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">
          ‚öôÔ∏è Pipeline Flow
        </h2>
        <div class="grid grid-cols-5 gap-4 mb-6">
          <div
            id="parse"
            class="flow-step bg-stage-parse text-white rounded-lg"
          >
            <div>1. PARSE</div>
          </div>
          <div
            id="logical"
            class="flow-step bg-stage-logical text-gray-800 rounded-lg"
          >
            <div>2. LOGICAL PLAN</div>
          </div>
          <div
            id="optimize"
            class="flow-step bg-stage-optimize text-white rounded-lg"
          >
            <div>3. OPTIMIZE</div>
          </div>
          <div
            id="physical"
            class="flow-step bg-stage-physical text-white rounded-lg"
          >
            <div>4. PHYSICAL</div>
          </div>
          <div
            id="execute"
            class="flow-step bg-stage-execute text-white rounded-lg"
          >
            <div>5. EXECUTE</div>
          </div>
        </div>

        <h3 class="text-lg font-medium text-gray-800 mb-2">
          üìü Terminal Output
        </h3>
        <div id="outputTerminal" class="terminal">
          <span class="text-yellow-400"
            >System Ready. Click a sample query or enter your own SQL.</span
          >
        </div>
      </div>

      <!-- Results Table -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">
          üìä Query Results
        </h2>
        <div id="resultTableContainer" class="overflow-x-auto">
          <div class="p-8 text-center text-gray-500">
            Results will appear here after execution
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://127.0.0.1:5000/run_query";
      const HEALTH_URL = "http://127.0.0.1:5000/health";
      const terminal = document.getElementById("outputTerminal");
      const resultTableContainer = document.getElementById(
        "resultTableContainer"
      );
      const pipelineSteps = [
        "parse",
        "logical",
        "optimize",
        "physical",
        "execute",
      ];

      // Default dataset
      const DEFAULT_DATA = `station_id,city,date,avg_temp_c,precipitation_mm,wind_speed_kmh
S001,St. John's,2025-09-01,15.2,5.5,25
S002,Gander,2025-09-01,12.8,10.1,35
S003,Corner Brook,2025-09-01,14.5,2.0,18
S004,St. John's,2025-09-02,16.0,0.0,20
S005,Gander,2025-09-02,13.5,0.5,30
S006,Corner Brook,2025-09-02,15.0,0.0,15
S007,St. John's,2025-09-03,14.8,8.2,28
S008,Gander,2025-09-03,11.5,12.5,40
S009,Corner Brook,2025-09-03,13.0,3.5,22
S010,Labrador City,2025-09-01,8.5,0.0,45
S011,Labrador City,2025-09-02,9.2,1.5,42
S012,Labrador City,2025-09-03,7.8,0.2,48
S013,St. Anthony,2025-09-01,11.0,6.0,32
S014,St. Anthony,2025-09-02,12.5,2.5,28
S015,St. Anthony,2025-09-03,10.8,9.0,35`;

      // Sample queries
      const QUERIES = {
        1: "SELECT city, avg_temp_c FROM nl_weather WHERE avg_temp_c > 14.0",
        2: "SELECT city, avg_temp_c FROM nl_weather WHERE avg_temp_c > 14.0 LIMIT 2",
        3: "SELECT city, avg_temp_c + 32 FROM nl_weather WHERE avg_temp_c > 13.0 LIMIT 2",
        4: "SELECT station_id, date, precipitation_mm FROM nl_weather WHERE city = 'Gander'",
        5: "SELECT station_id, city, date, avg_temp_c, precipitation_mm, wind_speed_kmh FROM nl_weather WHERE precipitation_mm > 0.0 LIMIT 5",
        6: "SELECT city, avg_temp_c + 5, precipitation_mm + 2 FROM nl_weather WHERE city = 'Corner Brook'",
      };

      function loadQuery(num) {
        document.getElementById("sqlInput").value = QUERIES[num];
        document
          .querySelectorAll(".query-preset")
          .forEach((el) => el.classList.remove("selected"));
        event.currentTarget.classList.add("selected");
      }

      function log(message, colorClass = "text-gray-300") {
        terminal.innerHTML += `<div class="${colorClass}">${message}</div>`;
        terminal.scrollTop = terminal.scrollHeight;
      }

      function resetUI() {
        pipelineSteps.forEach((id) => {
          document.getElementById(id)?.classList.remove("active-step");
        });
        terminal.innerHTML = "";
        resultTableContainer.innerHTML =
          '<div class="p-8 text-center text-gray-500">Processing...</div>';
      }

      async function activateStep(stepId) {
        pipelineSteps.forEach((id) => {
          document.getElementById(id)?.classList.remove("active-step");
        });
        document.getElementById(stepId)?.classList.add("active-step");
        await new Promise((resolve) => setTimeout(resolve, 300));
      }

      function getStepColor(stepId) {
        const colors = {
          data: "text-gray-400",
          parse: "text-stage-parse",
          logical: "text-stage-logical",
          optimize: "text-stage-optimize",
          physical: "text-stage-physical",
          execute: "text-stage-execute",
          error: "text-red-500",
        };
        return colors[stepId] || "text-white";
      }

      function renderTable(records) {
        if (!records || records.length === 0) {
          resultTableContainer.innerHTML =
            '<div class="p-8 text-center text-red-500 font-bold">No records returned</div>';
          return;
        }

        const headers = Object.keys(records[0]);
        let html =
          '<table class="result-table bg-white rounded-lg shadow-md"><thead><tr>';

        headers.forEach((header) => {
          html += `<th>${header.toUpperCase().replace(/_/g, " ")}</th>`;
        });
        html += "</tr></thead><tbody>";

        records.forEach((record) => {
          html += "<tr>";
          headers.forEach((header) => {
            const value =
              record[header] === null
                ? '<span class="text-gray-400 italic">NULL</span>'
                : record[header];
            html += `<td>${value}</td>`;
          });
          html += "</tr>";
        });

        html += "</tbody></table>";
        resultTableContainer.innerHTML = html;
      }

      async function checkServerHealth() {
        try {
          const response = await fetch(HEALTH_URL);
          const data = await response.json();
          if (data.status === "ok") {
            document.getElementById("statusIndicator").style.color = "#22c55e";
            document.getElementById("statusText").textContent = "Server Online";
            return true;
          }
        } catch (error) {
          document.getElementById("statusIndicator").style.color = "#ef4444";
          document.getElementById("statusText").textContent = "Server Offline";
          return false;
        }
      }

      async function runQuery() {
        const runButton = document.getElementById("runButton");
        runButton.disabled = true;
        runButton.textContent = "‚è≥ Processing Pipeline...";
        resetUI();

        try {
          const sqlQuery = document.getElementById("sqlInput").value.trim();
          const tableName = document.getElementById("tableName").value.trim();
          const mockDataCSV = document.getElementById("dataInput").value.trim();

          if (!sqlQuery) {
            throw new Error("Please enter a SQL query");
          }

          log("üì° Sending request to Flask API...", "text-yellow-400");

          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              sql_query: sqlQuery,
              csv_data: mockDataCSV,
              table_name: tableName,
            }),
          });

          const result = await response.json();

          if (!response.ok || result.error) {
            throw new Error(result.error || `Server error: ${response.status}`);
          }

          log("\n" + "=".repeat(70), "text-yellow-400");
          log("PIPELINE EXECUTION LOG", "text-yellow-400");
          log("=".repeat(70), "text-yellow-400");

          for (const logEntry of result.log) {
            const { stage, message } = logEntry;
            await activateStep(stage);
            const colorClass = getStepColor(stage);
            log(`\n[${stage.toUpperCase()}] ${message}`, colorClass);
          }

          log("\n" + "=".repeat(70), "text-yellow-400");
          log("DETAILED PLAN TREES", "text-yellow-400");
          log("=".repeat(70), "text-yellow-400");

          log(
            `\n[LOGICAL PLAN - Initial]\n${result.stages.logical}`,
            getStepColor("logical")
          );
          log(
            `\n[LOGICAL PLAN - Optimized]\n${result.stages.optimize}`,
            getStepColor("optimize")
          );
          log(
            `\n[PHYSICAL PLAN]\n${result.stages.physical}`,
            getStepColor("physical")
          );

          const finalRecords = JSON.parse(result.stages.execute);
          renderTable(finalRecords);

          log(`\n${"=".repeat(70)}`, "text-stage-execute");
          log(
            `‚úì EXECUTION COMPLETE: ${finalRecords.length} rows returned`,
            "text-stage-execute"
          );
          log("=".repeat(70), "text-stage-execute");
        } catch (error) {
          log(`\n‚ùå ERROR: ${error.message}`, "text-red-500");
          if (error.message.includes("fetch")) {
            log(
              "\nüí° TIP: Make sure Flask server is running (python app.py)",
              "text-yellow-400"
            );
          }
          resultTableContainer.innerHTML = `<div class="p-8 text-center text-red-500">${error.message}</div>`;
        } finally {
          runButton.disabled = false;
          runButton.textContent = "‚ñ∂ EXECUTE QUERY PIPELINE";
          document.getElementById("execute")?.classList.add("active-step");
        }
      }

      // Initialize
      window.onload = () => {
        document.getElementById("dataInput").value = DEFAULT_DATA;
        loadQuery(1);
        checkServerHealth();
        log("‚úì System initialized. Server status checked.", "text-green-400");
        log(
          "üìö Click a sample query above or enter your own SQL.",
          "text-yellow-400"
        );
      };
    </script>
  </body>
</html>
